{% extends "dashboard/base.html" %}
{% load staticfiles %}
{% block content %}
<!-- TODO: refractor this code
{{ result | safe }}-->

<div id="map-canvas"></div>
<script type="text/javascript" src="http://maps.google.com/maps/api/js"></script>
<script type="text/javascript">
    var tweets = {{ result | safe }};
</script>
<script type="text/javascript" src="{% static 'maptheme.js' %}"></script>
<script type="text/javascript" src="{% static 'map.js' %}"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>

<div class="container">
    <div class="row">
        <script type="text/javascript">
            google.load("visualization", "1", {packages:["corechart"]});
            var numPosList = new Array();
            var numNegList = new Array();

            // get all chart keys
            for(var i = 0; i < tweets.length; i++) {
                var chartKey = tweets[i].chartKey;
                if(!(chartKey in numPosList)) {
                    numPosList[chartKey] = 0;
                }
                if(!(chartKey in numNegList)) {
                    numNegList[chartKey] = 0;
                }
            }
            numPosList["Others"] = 0;
            numNegList["Others"] = 0;

            if(numPosList.length != numNegList.length) {
                throw { name: 'FatalError', message: 'Number of items of both charts are different, should not happen!' };
            }

            // count based on chart keys
            for(var i = 0; i < tweets.length; i++) {
                var chartKey = tweets[i].chartKey;
                if(tweets[i].sent == "pos") {
                    if(chartKey in numPosList) {
                        numPosList[chartKey]++;
                    } else {
                        numPosList["Others"]++;
                    }
                } else if(tweets[i].sent == "neg") {
                    if(chartKey in numNegList) {
                        numNegList[chartKey]++;
                    } else {
                        numNegList["Others"]++;
                    }
                }
            }
        </script>
        <div class="col-md-6">
            <script type="text/javascript">
                function drawChart() {
                    var dataArray = new Array();
                    dataArray.push(['Company', 'Percentage']);
                    for(var key in numPosList) {
                        var percentage = parseInt(numPosList[key]) / (parseInt(numPosList[key]) + parseInt(numNegList[key]));
                        dataArray.push([key, percentage]);
                    }
                    var data = google.visualization.arrayToDataTable(dataArray);
                    var options = {
                    	title: 'Positive Sentiment Comparison',
                        is3D: true,
                    	backgroundColor: '#F0F0F0',
                        pieSliceText: 'label',
                        colors: ['#7BE091', '#9CD5A8', '#74A67F', '#438651', '#52D06E'],
                    };
                    var chart = new google.visualization.PieChart(document.getElementById('piechart'));
                    chart.draw(data, options);
                }
            </script>
            <div id="piechart" style="width: 100%; height: 350px;"></div>
        </div>
        <div class="col-md-6">
            <script type="text/javascript">
                function drawChart2() {
                    var dataArray = new Array();
                    dataArray.push(['Company', 'Percentage']);
                    for(var key in numNegList) {
                        var percentage = parseInt(numNegList[key]) / (parseInt(numPosList[key]) + parseInt(numNegList[key]));
                        dataArray.push([key, percentage]);
                    }
                    var data = google.visualization.arrayToDataTable(dataArray);
                    var options = {
                        title: 'Negative Sentiment Comparison',
                        is3D: true,
                        backgroundColor: '#F0F0F0',
                        pieSliceText: 'label',
                        colors: ['#e0440e', '#e6693e', '#ec8f6e', '#f3b49f', '#f6c7b6'],
                    };
                    var chart = new google.visualization.PieChart(document.getElementById('piechart2'));
                    chart.draw(data, options);
                }
            </script>
            <div id="piechart2" style="width: 100%; height: 350px;"></div>
        </div>
        <script type="text/javascript">
            google.setOnLoadCallback(drawChart);
            google.setOnLoadCallback(drawChart2);
        </script>
    </div>
</div>
<div style="border-bottom:1px solid #000000;"></div>
{% endblock %}
