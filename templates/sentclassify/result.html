<!-- TODO: refractor this code
{{ result | safe }}-->
<head>
<style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
</style>
</head>

<div id="map-canvas"></div>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
{% load staticfiles %}
<script type="text/javascript">
var tweets = {{ result | safe }};
</script>
<script type="text/javascript">
var geocoder;
var map;
var infowindow = new google.maps.InfoWindow();

function initialize() {
	geocoder = new google.maps.Geocoder();
    var mapOptions = {
        center: new google.maps.LatLng(39.5,-98.35),
        zoom: 4
    };
    window.map = new google.maps.Map(document.getElementById('map-canvas'),
        mapOptions);

	var funcs = [];
	
	function createfunc(t) {
		return function(results, status) {
			if (status == google.maps.GeocoderStatus.OK) {
				map.setCenter(results[0].geometry.location);
				var marker = new google.maps.Marker({
				    map: map,
				    position: results[0].geometry.location
				});
				addMarker(results[0].geometry.location, t.username,
            		t.time, t.text);
		  	}
      	};
	}

	for (var i = 0; i < tweets.length; i++) {
		var t = tweets[i];
		funcs[i] = createfunc(t);
	}

    for (var i = 0; i < tweets.length; i++) {
        var t = tweets[i];
    	geocoder.geocode( { 'address': t.userlocation}, funcs[i]);
    }
}

function addMarker(location, userName, userTweet, userSent) {
    var contentString = '<div id="content">' +
        '<h1>' + userName + '</h1>' +
        '<h2>' + userTweet + '</h2>' +
        '<p>' + userSent + '</p></div>';

	var pinIcon = new google.maps.MarkerImage(
		{% static "posicon.png" %},
		null, /* size is determined at runtime */
		null, /* origin is 0,0 */
		null, /* anchor is bottom center of the scaled image */
		new google.maps.Size(30, 30)
	);

    var marker = new google.maps.Marker({
        position: location,
        icon: pinIcon;
        map: map,
        title: userTweet,
        draggable: false
    });
    google.maps.event.addListener(marker, 'click', function() {
        infowindow.setContent(contentString);
        infowindow.open(window.map, marker);
    });
}

google.maps.event.addDomListener(window, 'load', initialize);
</script>
